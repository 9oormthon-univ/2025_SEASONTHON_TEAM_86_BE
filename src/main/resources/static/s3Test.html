<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S3 업로드 테스트</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .form-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, button {
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .loading {
            color: #007bff;
        }
        .image-preview {
            max-width: 300px;
            margin: 10px 0;
        }
        .url-display {
            word-break: break-all;
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
<h1>S3 이미지 업로드 테스트</h1>

<div class="form-group">
    <label for="baseUrl">Backend URL:</label>
    <input type="text" id="baseUrl" value="http://localhost:8080" placeholder="http://localhost:8080">
</div>

<div class="form-group">
    <label for="userId">사용자 ID:</label>
    <input type="number" id="userId" value="1" min="1">
</div>

<div class="form-group">
    <label for="imageType">이미지 타입:</label>
    <select id="imageType">
        <option value="restaurant">Restaurant</option>
        <option value="menu">Menu</option>
    </select>
</div>

<div class="form-group">
    <label for="fileInput">이미지 파일 선택:</label>
    <input type="file" id="fileInput" accept="image/*">
</div>

<button id="uploadBtn" onclick="uploadImage()">업로드 테스트</button>

<div id="result" class="result" style="display: none;"></div>

<script>
    let uploadedImageUrl = null;

    async function uploadImage() {
        const baseUrl = document.getElementById('baseUrl').value;
        const userId = document.getElementById('userId').value;
        const imageType = document.getElementById('imageType').value;
        const fileInput = document.getElementById('fileInput');
        const resultDiv = document.getElementById('result');
        const uploadBtn = document.getElementById('uploadBtn');

        // 입력 검증
        if (!fileInput.files[0]) {
            showResult('파일을 선택해주세요.', 'error');
            return;
        }

        const file = fileInput.files[0];

        // 파일 타입 검증
        if (!file.type.startsWith('image/')) {
            showResult('이미지 파일만 업로드 가능합니다.', 'error');
            return;
        }

        uploadBtn.disabled = true;
        showResult('업로드 중...', 'loading');

        try {
            // 1단계: Presigned URL 생성
            showResult('1단계: Presigned URL 생성 중...', 'loading');

            const presignedResponse = await fetch(`${baseUrl}/api/images/upload-url/temp`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `imageType=${imageType}&fileName=${encodeURIComponent(file.name)}&userId=${userId}`
            });

            if (!presignedResponse.ok) {
                const errorText = await presignedResponse.text();
                throw new Error(`Presigned URL 생성 실패: ${presignedResponse.status} - ${errorText}`);
            }

            const presignedData = await presignedResponse.json();
            console.log('Presigned URL 응답:', presignedData);

            // 2단계: S3에 실제 파일 업로드
            showResult('2단계: S3에 이미지 업로드 중...', 'loading');

            const uploadResponse = await fetch(presignedData.presignedUrl, {
                method: 'PUT',
                body: file,
                headers: {
                    'Content-Type': file.type
                }
            });

            if (!uploadResponse.ok) {
                throw new Error(`S3 업로드 실패: ${uploadResponse.status}`);
            }

            // 성공!
            uploadedImageUrl = presignedData.imageUrl;
            showResult('업로드 성공!', 'success', presignedData);

        } catch (error) {
            console.error('업로드 에러:', error);
            showResult(`업로드 실패: ${error.message}`, 'error');
        } finally {
            uploadBtn.disabled = false;
        }
    }

    function showResult(message, type, data = null) {
        const resultDiv = document.getElementById('result');
        resultDiv.style.display = 'block';
        resultDiv.className = `result ${type}`;

        let html = `<strong>${message}</strong>`;

        if (data) {
            html += `
                    <div style="margin-top: 15px;">
                        <h4>업로드 정보:</h4>
                        <p><strong>파일명:</strong> ${data.fileName}</p>
                        <div class="url-display">
                            <strong>이미지 URL:</strong><br>
                            ${data.imageUrl}
                        </div>
                        <div>
                            <strong>미리보기:</strong><br>
                            <img src="${data.imageUrl}" alt="업로드된 이미지" class="image-preview"
                                 onload="console.log('이미지 로드 성공')"
                                 onerror="console.error('이미지 로드 실패')">
                        </div>
                        <button onclick="testDeleteImage('${data.imageUrl}')" style="margin-top: 10px; background-color: #dc3545;">
                            이미지 삭제 테스트
                        </button>
                    </div>
                `;
        }

        resultDiv.innerHTML = html;
    }

    async function testDeleteImage(imageUrl) {
        if (!confirm('정말 이미지를 삭제하시겠습니까?')) return;

        const baseUrl = document.getElementById('baseUrl').value;
        const userId = document.getElementById('userId').value;

        try {
            showResult('이미지 삭제 중...', 'loading');

            const response = await fetch(`${baseUrl}/api/images/temp?imageUrl=${encodeURIComponent(imageUrl)}&userId=${userId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                const result = await response.text();
                showResult('이미지 삭제 성공! ' + result, 'success');
            } else {
                const errorText = await response.text();
                throw new Error(`삭제 실패: ${response.status} - ${errorText}`);
            }
        } catch (error) {
            showResult(`삭제 실패: ${error.message}`, 'error');
        }
    }

    // 파일 선택 시 미리보기
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            console.log('선택된 파일:', {
                name: file.name,
                size: file.size,
                type: file.type
            });
        }
    });
</script>
</body>
</html>